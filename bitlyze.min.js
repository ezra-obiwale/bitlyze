(function(e){function t(){u||localStorage.setItem("btz",JSON.stringify(r))}var r={},n=localStorage.getItem("btz"),u=0;n&&(r=JSON.parse(n)),e.bitlyze=function(n,l,o){return new Promise(function(s,a){return r[n]?r[n].short?Promise.resolve(r[n].short):(u++,void r[n].queue.push({resolve:s,reject:a})):(u++,r[n]={queue:[{resolve:s,reject:a}]},o=o||"https://api-ssl.bitly.com/v3/shorten",o+=o.indexOf("?")===-1?"?":"&",o+="format=txt",o+="&access_token="+l,o+="&longUrl="+encodeURIComponent(n),void e.get(o).then(function(e){for(var l=0;l<r[n].queue.length;l++)r[n].queue[l].resolve(e),u--;r[n].queue=[],t()}).catch(function(){for(var e=0;e<r[n].queue.length;e++)r[n].queue[e].reject.apply(null,arguments),u--;r[n].queue=[],t()}))})},e.fn.bitlyze=function(t){var n={bitlyUrl:"https://api-ssl.bitly.com/v3/shorten",accessToken:"",urlAttr:"data-url",callback:function(e){}};return e.extend(n,t),this.each(function(){if(!e(this).hasClass("bitlyzed")){var t=e(this),u=t.attr(n.urlAttr);e.bitlyze(u,n.accessToken,n.bitlyUrl).then(function(t){r[u].short=t;for(var l=0;l<r[u].queue.length;l++)e(r[u].queue[l]).addClass("bitlyzed").attr(n.urlAttr,t),n.callback.call(r[u].queue[l],t)})}}),this}})(jQuery);